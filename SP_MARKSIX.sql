
ALTER   PROCEDURE [dbo].[SP_MARKSIX]
(@paraIn NVARCHAR(MAX),
@paraOut NVARCHAR(MAX) OUTPUT)
AS
BEGIN
/*
DECLARE @paraOUT NVARCHAR(MAX)
EXEC get_http 'https://bet.hkjc.com/marksix/Results.aspx?lang=ch', @paraOUT OUTPUT
SELECT  @paraOUT

DECLARE @paraIn NVARCHAR(MAX)
DECLARE @paraOut NVARCHAR(MAX)
SET @paraIn = '{"TYPE":"IMPORT_DATA","STARTDATE":"20230101","ENDDATE":"20240331","COOKIE":"s_ecid=MCMID%7C74063766126447319302458112420752425831; ASP.NET_SessionId=gwan3sjhxotkprchpkk1v1fr; AMCVS_06AB2C1653DB07AD0A490D4B%40AdobeOrg=1; s_cc=true; isEU=false; ADRUM=s=1708959628001&r=https%3A%2F%2Fbet.hkjc.com%2Fmarksix%2FResults.aspx%3Fhash%3D-1924203627; BotMitigationCookie_9518109003995423458=\"342053001708959991SOXSf5KdwY8rV8vswpn9UVCJGd8=\"; AMCV_06AB2C1653DB07AD0A490D4B%40AdobeOrg=1585540135%7CMCIDTS%7C19779%7CMCMID%7C74063766126447319302458112420752425831%7CMCAAMLH-1709564832%7C3%7CMCAAMB-1709564832%7CRKhpRz8krg2tLO6pguXWp5olkAcUniQYPHaMWWgdJ3xzPWQmdj0y%7CMCOPTOUT-1708967232s%7CNONE%7CMCAID%7CNONE%7CvVersion%7C4.4.0; s_visit=1; gpv_p5=https%3A%2F%2Fbet.hkjc.com%2Fmarksix%2FResults.aspx%3Flang%3Dch; s_sq=hkjcweb-prd%3D%2526c.%2526a.%2526activitymap.%2526page%253Dbet.hkjc.com%25252Fmarksix%25252Fresults.aspx%2526link%253D%2525E6%252590%25259C%2525E5%2525B0%25258B%2526region%253DdrawResultsAll%2526pageIDType%253D1%2526.activitymap%2526.a%2526.c%2526pid%253Dbet.hkjc.com%25252Fmarksix%25252Fresults.aspx%2526pidt%253D1%2526oid%253Dfunction%252528e%252529%25257Bvarr%25253Db.Qa%252528d%25252Ce%25252Ck%25252Ch%252529%25253Ba.conf.ka%252526%252526%252528r.pa%25253Du%252529%25253Breturnb.vh%252528p%25252Cr%25252Cthis%25252Carguments%252529%25257D%2526oidt%253D2%2526ot%253DDIV"}'
EXEC SP_MARKSIX @paraIn, @paraOut OUTPUT
SELECT @paraOut

DECLARE @paraIn NVARCHAR(MAX)
DECLARE @paraOut NVARCHAR(MAX)
SET @paraIn = '{"TYPE":"IMPORT_NUM"}'
EXEC SP_MARKSIX @paraIn, @paraOut OUTPUT
SELECT @paraOut
SELECT * FROM eMarkSix
CREATE TABLE eMarkSix
(
	msSEQ	INT NOT NULL PRIMARY KEY IDENTITY(1,1),
	msID	NVARCHAR(20) NOT NULL,
	msDATE	DATETIME NOT NULL,
	msNO    NVARCHAR(50) NOT NULL,
	msSNO	NVARCHAR(10) NOT NULL,
	msSBCODE	NVARCHAR(50) NOT NULL,
	msSBNAMEE	NVARCHAR(100) NOT NULL,
	msSBNAMEC	NVARCHAR(100) NOT NULL,
	msINV	NUMERIC(20,0),
	msP1	NUMERIC(20,0),
	msP1U	NUMERIC(20,0),
	msP2	NUMERIC(20,0),
	msP2U	NUMERIC(20,0),
	msP3	NUMERIC(20,0),
	msP3U	NUMERIC(20,0),
	msP4	NUMERIC(20,0),
	msP4U	NUMERIC(20,0),
	msP5	NUMERIC(20,0),
	msP5U	NUMERIC(20,0),
	msP6	NUMERIC(20,0),
	msP6U	NUMERIC(20,0),
	msP7	NUMERIC(20,0),
	msP7U	NUMERIC(20,0)
)

CREATE TABLE eMarkSixNumItem
(
	msniSEQ	INT NOT NULL PRIMARY KEY IDENTITY(1,1),
	msSEQ	INT NOT NULL,
	msniNO	INT NOT NULL,
	msniISSNO BIT NOT NULL DEFAULT 0
)

CREATE TABLE eMarkSixNumAIDraw
(
	msnaidSEQ INT NOT NULL PRIMARY KEY IDENTITY(1,1),
	msnaidDATE DATETIME NOT NULL,
	msnaidNO NVARCHAR(40),
	msnaidSNO NVARCHAR(40),
	msnaidISWIN BIT
)

CREATE TABLE eMarkSixNumAIDrawNum
(
	msnaidnSEQ INT NOT NULL PRIMARY KEY IDENTITY(1,1),
	msnaidSEQ INT NOT NULL,
	msnaidnNO INT NOT NULL,
	msnaidnIS BIT
)
*/
	DECLARE @TYPE NVARCHAR(50)
	DECLARE @sSTARTDATE NVARCHAR(50)
	DECLARE @sENDDATE NVARCHAR(50)
	DECLARE @dtSTARTDATE DATETIME
	DECLARE @dtENDDATE DATETIME
	DECLARE @COOKIE varchar(8000)
	DECLARE @sScript NVARCHAR(MAX)
	DECLARE @paraMSIn NVARCHAR(MAX)
	DECLARE @paraMSOut NVARCHAR(MAX)
	
	DECLARE @tbl_DATA TABLE
	(
		JSONDATA NVARCHAR(MAX)
	)

	SELECT  
		@TYPE = TYPE,
		@sSTARTDATE = STARTDATE,
		@sENDDATE = ENDDATE,
		@COOKIE = COOKIE
		FROM OPENJSON(@paraIn) 
	WITH (
		TYPE NVARCHAR(50),
		STARTDATE NVARCHAR(50),
		ENDDATE NVARCHAR(50),
		COOKIE VARCHAR(8000)
		) AS rData
	
	IF (@TYPE = 'IMPORT_NUM')
	BEGIN
		DECLARE @tmp_SEQ TABLE
		(
			SEQ INT
		)
		DECLARE @SEQ INT
		DECLARE @msNO NVARCHAR(MAX)

		IF OBJECT_ID('tempdb..#tmp_eMarkSix') IS NOT NULL DROP TABLE #tmp_eMarkSix
		SELECT * INTO #tmp_eMarkSix FROM eMarkSix WHERE msSEQ NOT IN (SELECT msSEQ FROM eMarkSixNumItem)

		INSERT INTO eMarkSixNumItem(msSEQ,msniNO,msniISSNO)
		SELECT msSEQ,msSNO,1 FROM #tmp_eMarkSix

		WHILE (EXISTS(SELECT * FROM #tmp_eMarkSix  WHERE msSEQ NOT IN (SELECT SEQ FROM @tmp_SEQ)))
		BEGIN
			SET @SEQ = (SELECT TOP 1 msSEQ  FROM #tmp_eMarkSix  WHERE msSEQ NOT IN (SELECT SEQ FROM @tmp_SEQ))
 
			INSERT INTO @tmp_SEQ(SEQ) VALUES (@SEQ)

			SET @msNO = (SELECT msNO FROM #tmp_eMarkSix WHERE msSEQ = @SEQ)
			INSERT INTO eMarkSixNumItem(msSEQ,msniNO,msniISSNO)
			SELECT @SEQ,value,0 FROM string_split(@msNO,'+')

			DELETE FROM #tmp_eMarkSix WHERE msSEQ = @SEQ
		END


		
	END
	IF (@TYPE = 'IMPORT_DATA')
	BEGIN
		SET @dtSTARTDATE = CONVERT(DATETIME,@sSTARTDATE,112)

		SET @dtENDDATE = DATEADD(DAY,1,@dtSTARTDATE)
		WHILE @dtENDDATE <= GETDATE() AND @dtSTARTDATE < @dtENDDATE
		BEGIN
			SELECT @dtENDDATE
			IF (DATEADD(DAY,90,@dtENDDATE) >= CONVERT(DATETIME,@sENDDATE,112))
			BEGIN
				SET @dtSTARTDATE = @dtENDDATE
				SET @dtENDDATE = CONVERT(DATETIME,@sENDDATE,112)
			END
			ELSE
			BEGIN
				SET @dtSTARTDATE = @dtENDDATE
				SET @dtENDDATE = DATEADD(DAY,90,@dtENDDATE)
			END
			SELECT @dtSTARTDATE,@dtENDDATE
			IF (@dtSTARTDATE <= GETDATE() AND @dtSTARTDATE != @dtENDDATE)
			BEGIN
				SET @paraMSIn = 'https://bet.hkjc.com/marksix/getJSON.aspx?sd='+ CONVERT(NVARCHAR,@dtSTARTDATE,112) +'&ed='+ CONVERT(NVARCHAR,@dtENDDATE,112) +'&sb=0'
				EXEC get_http @paraMSIn, @COOKIE,@paraMSOut OUTPUT
				
				INSERT INTO eMarkSix(msID, msDATE, msNO, msSNO, msSBCODE, msSBNAMEE, msSBNAMEC, msINV, msP1, msP1U, 
                            msP2, msP2U, msP3, msP3U, msP4, msP4U, msP5, msP5U, msP6, msP6U, msP7, msP7U)
				SELECT  
					id,CONVERT(DATETIME,[date],105),no,sno,sbcode,sbnameE,sbnameC,
					CONVERT(NUMERIC(20,0),REPLACE(inv,',','')),
					CONVERT(NUMERIC(20,0),REPLACE(p1,',','')),
					CONVERT(NUMERIC(20,0),REPLACE(p1u,',','')),
					CONVERT(NUMERIC(20,0),REPLACE(p2,',','')),
					CONVERT(NUMERIC(20,0),REPLACE(p2u,',','')),
					CONVERT(NUMERIC(20,0),REPLACE(p3,',','')),
					CONVERT(NUMERIC(20,0),REPLACE(p3u,',','')),
					CONVERT(NUMERIC(20,0),REPLACE(p4,',','')),
					CONVERT(NUMERIC(20,0),REPLACE(p4u,',','')),
					CONVERT(NUMERIC(20,0),REPLACE(p5,',','')),
					CONVERT(NUMERIC(20,0),REPLACE(p5u,',','')),
					CONVERT(NUMERIC(20,0),REPLACE(p6,',','')),
					CONVERT(NUMERIC(20,0),REPLACE(p6u,',','')),
					CONVERT(NUMERIC(20,0),REPLACE(p7,',','')),
					CONVERT(NUMERIC(20,0),REPLACE(p7u,',',''))
					FROM OPENJSON(@paraMSOut) 
				WITH (
					id [nvarchar](20),
					date NVARCHAR(30),
					no [nvarchar](50),
					sno [nvarchar](10),
					sbcode [nvarchar](50),
					sbnameE [nvarchar](100),
					sbnameC [nvarchar](100),
					inv NVARCHAR(30),
					p1 NVARCHAR(30),
					p1u NVARCHAR(30),
					p2 NVARCHAR(30),
					p2u NVARCHAR(30),
					p3 NVARCHAR(30),
					p3u NVARCHAR(30),
					p4 NVARCHAR(30),
					p4u NVARCHAR(30),
					p5 NVARCHAR(30),
					p5u NVARCHAR(30),
					p6 NVARCHAR(30),
					p6u NVARCHAR(30),
					p7 NVARCHAR(30),
					p7u NVARCHAR(30)
					) AS rData
				WHERE id NOT IN (SELECT msID FROM eMarkSix WITH (NOLOCK))
			END
				--[{"id":"04/031","date":"30/03/2004","no":"9+11+21+27+37+45","sno":"30","sbcode":"","sbnameE":"","sbnameC":"","inv":"42,128,821","p1":"2,587,115","p1u":"4.0","p2":"0","p2u":"0.0","p3":"18,540","p3u":"256.4","p4":"4,800","p4u":"355.0","p5":"320","p5u":"10,894.6","p6":"160","p6u":"9,070.4","p7":"20","p7u":"166,395.8"},
		END
	END
END


 
